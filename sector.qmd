---
title: "SECTOR ANALYTICS"
page-layout: custom
execute:
  echo: false
  warning: false
format:
  html:
    css: styles.css
    toc: false
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* --- ESTILOS GENERALES (Dark Theme FNEE) --- */
body {
  background-color: #0f172a; color: #cbd5e1;
  font-family: 'Inter', sans-serif; margin: 0; padding: 0;
}
.main-wrapper { max-width: 1600px; margin: 0 auto; padding: 30px; }

/* CABECERA */
.header-section {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 20px;
}
.page-title { font-size: 1.8rem; font-weight: 700; color: #fff; margin: 0; }
.page-subtitle { color: #64748b; font-size: 0.9rem; margin-top: 5px; }

/* PESTAÑAS (3 OPCIONES) */
.nav-pills {
  display: flex; gap: 5px; background: #1e293b; padding: 5px; border-radius: 10px;
}
.nav-item {
  padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
  color: #94a3b8; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
}
.nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
.nav-item.active {
  background-color: #0f172a; color: #2dd4bf;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid #334155;
}

/* TARJETAS */
.dashboard-card {
  background: #1e293b; border: 1px solid #334155; border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 25px; overflow: hidden;
}
.card-header {
  padding: 15px 25px; border-bottom: 1px solid #334155; background: rgba(15, 23, 42, 0.3);
  display: flex; justify-content: space-between; align-items: center;
}
.card-title { font-size: 1.1rem; font-weight: 600; color: #fff; margin: 0; }
.card-body { padding: 25px; }

/* TABLA DATOS */
.custom-table { width: 100%; border-collapse: collapse; }
.custom-table th {
  text-align: left; padding: 12px 15px; color: #94a3b8; font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #334155;
}
.custom-table td { padding: 14px 15px; border-bottom: 1px solid #334155; color: #e2e8f0; font-size: 0.9rem; }
.custom-table tr:hover { background-color: rgba(45, 212, 191, 0.05); }

/* BOTONES */
.btn-icon {
  width: 32px; height: 32px; border-radius: 6px; border: 1px solid #334155;
  background: #0f172a; color: #94a3b8; cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all 0.2s;
}
.btn-icon:hover { border-color: #2dd4bf; color: #2dd4bf; }

/* MODAL */
dialog.pro-modal {
  background: #1e293b; color: #fff; border: 1px solid #334155; border-radius: 16px;
  padding: 0; width: 90%; max-width: 1000px;
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  box-shadow: 0 50px 100px -20px rgba(0,0,0,0.9);
}
dialog.pro-modal::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }

/* INPUTS */
form { margin-bottom: 0; } /* Fix para margin extra de observable */
</style>

```{ojs}
//| echo: false
//| output: false

// --- 1. DATOS INCRUSTADOS (Blindados) ---
rawData = [
  {NIF: "A81948077", Empresa: "ENDESA ENERGIA, S.A.U.", V2021: 78500, V2022: 76200, V2023: 74100, V2024: 72050},
  {NIF: "A95758389", Empresa: "IBERDROLA CLIENTES, S.A.U.", V2021: 65400, V2022: 66800, V2023: 68900, V2024: 70100},
  {NIF: "B82846817", Empresa: "NATURGY IBERIA, S.A.", V2021: 45200, V2022: 44100, V2023: 43500, V2024: 42800},
  {NIF: "A33005396", Empresa: "TOTALENERGIES MERCADO ESPAÑA", V2021: 25000, V2022: 26500, V2023: 28000, V2024: 29500},
  {NIF: "B31737422", Empresa: "ACCIONA GREEN ENERGY", V2021: 6349, V2022: 7441, V2023: 8334, V2024: 7806},
  {NIF: "B26500231", Empresa: "ADELFAS ENERGIA SL", V2021: 217, V2022: 108, V2023: 232, V2024: 142},
  {NIF: "B25794207", Empresa: "ADEINNOVA ENERGIA SL", V2021: 81, V2022: 81, V2023: 73, V2024: 98},
  {NIF: "A87623971", Empresa: "ACSOL ENERGIA GLOBAL SA", V2021: 45, V2022: 36, V2023: 31, V2024: 28},
  {NIF: "B87177408", Empresa: "ABOUTWHITE SL", V2021: 52, V2022: 31, V2023: 28, V2024: 32},
  {NIF: "B22350466", Empresa: "AB ENERGIA 1903 S.L.", V2021: 87, V2022: 60, V2023: 50, V2024: 63}
];

// Procesado
years = [2021, 2022, 2023, 2024];
totalMarket = rawData.reduce((acc, curr) => acc + curr.V2024, 0);

dataLong = rawData.flatMap(d => years.map(y => ({
  Empresa: d.Empresa, NIF: d.NIF, Año: y, Ventas: d[`V${y}`]
})));

// Variables Reactivas
mutable currentTab = "mercado";
mutable selectedRow = null;

// Buscador Tabla
searchWidget = Inputs.search(rawData, {placeholder: "Buscar...", columns: ["Empresa", "NIF"]});
searchTerm = Generators.input(searchWidget);

// Selector Comparador (Multi-select)
viewof selectedCompanies = Inputs.select(rawData.map(d => d.Empresa), {
  multiple: true, 
  value: ["ENDESA ENERGIA, S.A.U.", "IBERDROLA CLIENTES, S.A.U."], 
  label: null
});
```

```{ojs}
//| echo: false

// --- 2. INTERFAZ VISUAL ---
htl.html`
<div class="main-wrapper">
  
  <div class="header-section">
    <div>
      <h1 class="page-title">Sector Analytics</h1>
      <div class="page-subtitle">Sistema de Inteligencia de Mercado</div>
    </div>
    
    <div class="nav-pills">
      <div class="nav-item ${currentTab === 'mercado' ? 'active' : ''}" onclick=${() => mutable currentTab = 'mercado'}>
        <i class="fa-solid fa-chart-simple"></i> Mercado
      </div>
      <div class="nav-item ${currentTab === 'comparador' ? 'active' : ''}" onclick=${() => mutable currentTab = 'comparador'}>
        <i class="fa-solid fa-code-compare"></i> Comparador
      </div>
      <div class="nav-item ${currentTab === 'datos' ? 'active' : ''}" onclick=${() => mutable currentTab = 'datos'}>
        <i class="fa-solid fa-table"></i> Datos
      </div>
    </div>
  </div>

  <div style="display: ${currentTab === 'mercado' ? 'block' : 'none'}; animation: fadeIn 0.3s;">
    <div class="dashboard-card">
      <div class="card-header">
        <h3 class="card-title">Volumen Total del Sistema</h3>
      </div>
      <div class="card-body">
        ${Plot.plot({
          style: {background: "transparent", color: "#cbd5e1", fontSize: "14px", fontFamily: "Inter"},
          height: 400, marginLeft: 60,
          y: {grid: true, label: "GWh", tickFormat: "s"},
          marks: [
            Plot.barY(dataLong, Plot.groupX({y: "sum"}, {
              x: "Año", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.8, tip: true, rx: 4
            })),
            Plot.ruleY([0], {stroke: "#334155"})
          ]
        })}
      </div>
    </div>
  </div>

  <div style="display: ${currentTab === 'comparador' ? 'block' : 'none'}; animation: fadeIn 0.3s;">
    <div class="dashboard-card">
      <div class="card-header">
        <h3 class="card-title">Análisis Competitivo</h3>
        <div style="width: 300px;"></div> </div>
      <div class="card-body">
        <div style="margin-bottom: 20px; color: #94a3b8; font-size: 0.9rem;">
          Selecciona las empresas que quieres comparar:
        </div>
        <div id="selector-mount"></div>
        
        <div style="margin-top: 20px;">
          ${Plot.plot({
            style: {background: "transparent", color: "#cbd5e1", fontSize: "14px"},
            height: 400, marginLeft: 60,
            color: {legend: true},
            y: {grid: true, label: "Ventas (GWh)"},
            marks: [
              Plot.lineY(dataLong.filter(d => selectedCompanies.includes(d.Empresa)), {
                x: "Año", y: "Ventas", stroke: "Empresa", strokeWidth: 3, marker: "circle", tip: true
              })
            ]
          })}
        </div>
      </div>
    </div>
  </div>

  <div style="display: ${currentTab === 'datos' ? 'block' : 'none'}; animation: fadeIn 0.3s;">
    <div class="dashboard-card">
      <div class="card-header" style="background:#1e293b;">
        <div style="flex:1;">${searchWidget}</div>
      </div>
      
      <div style="overflow-x:auto;">
        <table class="custom-table">
          <thead>
            <tr>
              <th style="width:15%">NIF</th>
              <th style="width:45%">Empresa</th>
              <th style="width:20%; text-align:right">2024 (GWh)</th>
              <th style="width:20%; text-align:center">Ficha</th>
            </tr>
          </thead>
          <tbody>
            ${searchTerm.map(row => htl.html`
              <tr>
                <td style="font-family:monospace; color:#94a3b8;">${row.NIF}</td>
                <td style="font-weight:600; color:#fff;">${row.Empresa}</td>
                <td style="text-align:right">${row.V2024.toLocaleString("es-ES")}</td>
                <td style="text-align:center; display:flex; justify-content:center;">
                  <button class="btn-icon" onclick=${() => mutable selectedRow = row}>
                    <i class="fa-solid fa-eye"></i>
                  </button>
                </td>
              </tr>
            `)}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>`
```

```{ojs}
//| echo: false
// 3. POPUP MODAL (Detalle individual desde la tabla)
{
  if (selectedRow) {
    const dialog = htl.html`<dialog class="pro-modal" open>
      <div style="padding:20px 30px; border-bottom:1px solid #334155; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; color:#fff; font-size:1.4rem;">${selectedRow.Empresa}</h2>
          <span style="font-family:monospace; color:#2dd4bf; background:rgba(45,212,191,0.1); padding:2px 8px; border-radius:4px; font-size:0.8rem;">${selectedRow.NIF}</span>
        </div>
        <button class="btn-icon" style="border:none; width:40px; height:40px; font-size:1.2rem;" onclick=${() => mutable selectedRow = null}>&times;</button>
      </div>
      <div style="padding:30px;">
        ${Plot.plot({
          style: {background: "transparent", color: "#cbd5e1"},
          height: 300, width: 900, grid: true, marginLeft: 60,
          marks: [
            Plot.lineY(dataLong.filter(d => d.Empresa === selectedRow.Empresa), {x: "Año", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 3}),
            Plot.areaY(dataLong.filter(d => d.Empresa === selectedRow.Empresa), {x: "Año", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.2})
          ]
        })}
      </div>
    </dialog>`;
    return dialog;
  }
}
```