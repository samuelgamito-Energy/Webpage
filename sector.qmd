---
title: "SECTOR ANALYTICS"
page-layout: full
format:
  html:
    toc: false
    css: styles.css
---

<style>
/* 1. GENERAL */
.observablehq { 
  color: #cbd5e1 !important; 
  font-family: 'Inter', sans-serif;
}

/* 2. TABLAS TRANSPARENTES Y ELEGANTES */
.observablehq-table { 
  color: #cbd5e1 !important; 
  background: transparent !important; 
}
.observablehq-table thead { 
  background-color: rgba(15, 23, 42, 0.9) !important; 
  border-bottom: 2px solid #2dd4bf !important; 
}
.observablehq-table th {
  color: #2dd4bf !important; 
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 1px;
}
.observablehq-table tr:hover {
  background-color: rgba(45, 212, 191, 0.1) !important; 
}

/* 3. INPUTS (BUSCADOR Y SELECTORES) */
form.observablehq-input input, 
form.observablehq-input select {
  background-color: #1e293b !important; 
  border: 1px solid #334155 !important;
  color: #f1f5f9 !important;
  border-radius: 6px;
  padding: 8px 12px;
}
form.observablehq-input { color: #94a3b8; }

/* 4. PESTA칌AS (TABS) */
.nav-tabs { border-bottom: 1px solid #334155; margin-bottom: 20px; }
.nav-tabs .nav-link { color: #94a3b8; border: none; }
.nav-tabs .nav-link.active { 
  background-color: transparent; 
  border-bottom: 3px solid #2dd4bf; 
  color: #2dd4bf; 
  font-weight: bold;
}
</style>

```{ojs}
//| echo: false

// --- 1. CARGA DE DATOS ---
raw = await FileAttachment("ventas_boe.csv").text()

// --- 2. LIMPIEZA DE FORMATO ---
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null; 
  // Quitar comillas envolventes
  if (l.startsWith('"') && l.endsWith('"')) l = l.slice(1, -1);
  // Quitar punto y coma final
  if (l.endsWith(';')) l = l.slice(0, -1);
  return l;
}).filter(l => l !== null).join("\n")

// --- 3. PARSEO Y CONVERSI칍N ---
data = d3.dsvFormat(";").parse(clean_csv, (d) => {
  for (const key in d) {
    if (key.includes("Ventas") && d[key]) {
      // Formato espa침ol 1.000,00 -> 1000.00
      let val = d[key].toString().replace(/\./g, "").replace(",", ".");
      d[key] = parseFloat(val) || 0;
    }
  }
  return d;
})

// --- 4. FORMATO LARGO (GR츼FICAS) ---
data_long = data.flatMap(d => {
  const years = [2019, 2020, 2021, 2022, 2023, 2024];
  return years.map(year => ({
    "Empresa": d["Raz칩n Social"],
    "NIF": d["NIF"],
    "A침o": year,
    "Ventas": d[`Ventas ${year}`] || 0
  }));
})
```

::: {.panel-tabset}

## 游댌 Buscador

Base de datos completa del sistema energ칠tico.

```{ojs}
//| echo: false
viewof search = Inputs.search(data, {
  label: "Buscar:",
  placeholder: "Ej: ENDESA, FENOSA...",
  columns: ["Raz칩n Social", "NIF"]
})

Inputs.table(search, {
  columns: ["NIF", "Raz칩n Social", "Ventas 2022", "Ventas 2023", "Ventas 2024"],
  header: {
    "Raz칩n Social": "Comercializadora",
    "Ventas 2022": "2022 (GWh)",
    "Ventas 2023": "2023 (GWh)",
    "Ventas 2024": "2024 (GWh)"
  },
  sort: "Ventas 2024",
  reverse: true,
  rows: 15,
  format: {
    "Ventas 2022": x => x.toLocaleString("es-ES", {maximumFractionDigits: 0}),
    "Ventas 2023": x => x.toLocaleString("es-ES", {maximumFractionDigits: 0}),
    "Ventas 2024": x => x.toLocaleString("es-ES", {maximumFractionDigits: 0})
  }
})
```

## 游늵 Mercado Global

Evoluci칩n del volumen total gestionado (GWh).

```{ojs}
//| echo: false
Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "14px" },
  height: 400,
  marginLeft: 60,
  y: { grid: true, label: "Total GWh", tickFormat: "s" },
  x: { label: null, tickFormat: "d" },
  marks: [
    Plot.barY(data_long, Plot.groupX({y: "sum"}, {
      x: "A침o", 
      y: "Ventas", 
      fill: "#2dd4bf", 
      fillOpacity: 0.8,
      tip: true
    })),
    Plot.ruleY([0], {stroke: "#475569"})
  ]
})
```

## 游 Comparador

An치lisis competitivo y cuota de mercado.

```{ojs}
//| echo: false
viewof selected_companies = Inputs.select(data.map(d => d["Raz칩n Social"]).sort(), {
  label: "Selecciona Empresas:",
  multiple: true,
  value: ["ENDESA ENERGIA, S.A.U.", "IBERDROLA CLIENTES, S.A.U."], 
  unique: true
})

filtered_data = data_long.filter(d => selected_companies.includes(d["Empresa"]))

Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "13px" },
  height: 450,
  marginRight: 130,
  x: { label: "A침o", tickFormat: "d", domain: [2019, 2024] },
  y: { label: "Ventas (GWh)", grid: true },
  marks: [
    Plot.lineY(filtered_data, {
      x: "A침o", 
      y: "Ventas", 
      stroke: "Empresa", 
      strokeWidth: 3, 
      marker: "circle",
      curve: "monotone-x", 
      tip: true
    }),
    Plot.text(filtered_data, Plot.selectLast({
      x: "A침o", 
      y: "Ventas", 
      z: "Empresa", 
      text: "Empresa", 
      textAnchor: "start", 
      dx: 10,
      fill: "#cbd5e1",
      fontWeight: "bold"
    }))
  ],
  color: { scheme: "spectral", legend: true }
})
```