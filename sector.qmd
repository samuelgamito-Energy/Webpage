---
title: "SECTOR ANALYTICS"
page-layout: custom
execute:
  echo: false
  warning: false
format:
  html:
    css: custom.css
    toc: false
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

```{ojs}
//| echo: false
//| output: false

// 1. IMPORTAR DATOS (Desde el archivo logic.js)
import { initialData } from "./logic.js";

// 2. ESTADO DE LA APLICACIÓN (Variables Reactivas)
mutable db = initialData; 
mutable currentTab = "mercado";
mutable selectedRow = null; 
mutable activeCompetitors = ["A95758389", "B83160994"];
mutable chartMode = "absolute"; 
years = [2020, 2021, 2022, 2023, 2024];

// 3. WIDGET DE BUSCADOR 
// Definimos el input aquí para que mantenga el estado y no pierda el foco al escribir
viewof searchWidget = Inputs.text({placeholder: "Buscar CIF o Nombre...", submit: false});

// 4. LÓGICA DE FILTRADO Y CÁLCULOS (Se actualizan automáticamente)

// Filtrado de la tabla principal
filteredTableData = {
  const term = searchWidget.toLowerCase(); // Leemos lo que escribes en el widget
  if (!term) return db;
  return db.filter(row => 
    row.Empresa.toLowerCase().includes(term) || 
    row.NIF.toLowerCase().includes(term)
  );
}

// Datos Agregados para la Gráfica de Mercado
marketData = years.map(y => ({
  Year: y.toString(), 
  Vol: db.reduce((a,b) => a + (b[`V${y}`] || 0), 0)
}));

// KPI: Total 2024
total2024 = marketData.find(d => d.Year === "2024")?.Vol || 0;

// KPI: Líder de Crecimiento
topGrower = {
  // Ordenamos por crecimiento absoluto (2024 - 2023)
  const sorted = [...db].sort((a,b) => (b.V2024 - b.V2023) - (a.V2024 - a.V2023));
  const top = sorted[0];
  return { name: top.Empresa, growth: (top.V2024 - top.V2023) };
}

// Transformación de datos para gráficas (Formato Largo/Tidy)
dataLong = db.flatMap(d => years.map(y => ({
  Empresa: d.Empresa, 
  NIF: d.NIF, 
  Año: y, 
  Ventas: d[`V${y}`] || 0
})));

// Lógica del Comparador (Filtrado y Base 100)
compData = {
  let filtered = dataLong.filter(d => activeCompetitors.includes(d.NIF));
  
  if (chartMode === "indexed") {
    // Si el modo es 'Base 100', recalculamos los valores
    filtered = filtered.map(d => {
      const baseYearVal = db.find(x => x.NIF === d.NIF)?.V2020 || 1; // Evitar división por 0
      return { 
        ...d, 
        Ventas: (d.Ventas / baseYearVal) * 100 
      }
    });
  }
  return filtered;
}
```

{{< include _interface.qmd >}}
{{< include _modal.qmd >}}