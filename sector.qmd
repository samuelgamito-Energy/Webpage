---
title: "SECTOR ANALYTICS"
page-layout: custom
execute:
  echo: false
  warning: false
format:
  html:
    toc: false
    css: styles.css
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* --- 1. BASE (Reset Dark Mode) --- */
body {
  background-color: #0f172a; /* Slate 900 */
  color: #cbd5e1; /* Slate 300 */
  font-family: 'Inter', sans-serif;
  margin: 0; padding: 0;
}

/* Contenedor Principal (Igual que tu HTML) */
.main-wrapper {
  max-width: 1600px;
  margin: 0 auto;
  padding: 30px;
}

/* --- 2. CABECERA Y TABS --- */
.header-section {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 20px;
}
.page-title {
  font-size: 1.8rem; font-weight: 700; color: #fff; letter-spacing: -0.5px; margin: 0;
}
.page-subtitle { color: #64748b; font-size: 0.9rem; margin-top: 5px; }

/* Botones de Pestaña (Estilo "Pill" como el HTML) */
.nav-pills {
  display: flex; gap: 8px; background: #1e293b; padding: 5px; border-radius: 10px;
}
.nav-item {
  padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
  color: #94a3b8; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
}
.nav-item:hover { color: #fff; }
.nav-item.active {
  background-color: #0f172a; color: #2dd4bf; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: 1px solid #334155;
}

/* --- 3. TARJETAS (CARDS) --- */
.dashboard-card {
  background: #1e293b; /* Slate 800 */
  border: 1px solid #334155;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  margin-bottom: 25px;
  overflow: hidden;
}
.card-header {
  padding: 20px 25px; border-bottom: 1px solid #334155;
  display: flex; justify-content: space-between; align-items: center;
}
.card-title { font-size: 1.1rem; font-weight: 600; color: #fff; margin: 0; }
.card-body { padding: 25px; }

/* --- 4. TABLA PROFESIONAL --- */
.custom-table { width: 100%; border-collapse: collapse; }
.custom-table th {
  text-align: left; padding: 12px 15px; color: #94a3b8; font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #334155;
}
.custom-table td {
  padding: 16px 15px; border-bottom: 1px solid #334155; color: #e2e8f0; font-size: 0.9rem;
}
.custom-table tr:last-child td { border-bottom: none; }
.custom-table tr:hover { background-color: rgba(45, 212, 191, 0.05); }

/* Badge de estado */
.badge {
  padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
  background: rgba(45, 212, 191, 0.1); color: #2dd4bf; border: 1px solid rgba(45, 212, 191, 0.2);
}

/* Botón Acción */
.btn-icon {
  width: 32px; height: 32px; border-radius: 6px; border: 1px solid #334155;
  background: #0f172a; color: #94a3b8; cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all 0.2s;
}
.btn-icon:hover { border-color: #2dd4bf; color: #2dd4bf; background: rgba(45, 212, 191, 0.1); }

/* --- 5. POPUP MODAL --- */
dialog.pro-modal {
  background: #1e293b; color: #fff; border: 1px solid #334155; border-radius: 16px;
  padding: 0; width: 90%; max-width: 1000px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.9);
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
}
dialog.pro-modal::backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }

/* KPIs Grid */
.kpi-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
}
.kpi-box {
  background: #0f172a; padding: 20px; border-radius: 10px; border: 1px solid #334155;
}
.kpi-label { font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
.kpi-value { font-size: 1.5rem; font-weight: 700; color: #fff; }
.kpi-trend { font-size: 0.85rem; color: #2dd4bf; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
</style>

```{ojs}
//| echo: false
//| output: false

// --- 1. DATOS INCRUSTADOS (Blindados) ---
rawData = [
  {NIF: "A81948077", Empresa: "ENDESA ENERGIA, S.A.U.", V2021: 78500, V2022: 76200, V2023: 74100, V2024: 72050},
  {NIF: "A95758389", Empresa: "IBERDROLA CLIENTES, S.A.U.", V2021: 65400, V2022: 66800, V2023: 68900, V2024: 70100},
  {NIF: "B82846817", Empresa: "NATURGY IBERIA, S.A.", V2021: 45200, V2022: 44100, V2023: 43500, V2024: 42800},
  {NIF: "A33005396", Empresa: "TOTALENERGIES MERCADO ESPAÑA", V2021: 25000, V2022: 26500, V2023: 28000, V2024: 29500},
  {NIF: "B31737422", Empresa: "ACCIONA GREEN ENERGY", V2021: 6349, V2022: 7441, V2023: 8334, V2024: 7806},
  {NIF: "B26500231", Empresa: "ADELFAS ENERGIA SL", V2021: 217, V2022: 108, V2023: 232, V2024: 142},
  {NIF: "B25794207", Empresa: "ADEINNOVA ENERGIA SL", V2021: 81, V2022: 81, V2023: 73, V2024: 98},
  {NIF: "A87623971", Empresa: "ACSOL ENERGIA GLOBAL SA", V2021: 45, V2022: 36, V2023: 31, V2024: 28},
  {NIF: "B87177408", Empresa: "ABOUTWHITE SL", V2021: 52, V2022: 31, V2023: 28, V2024: 32},
  {NIF: "B22350466", Empresa: "AB ENERGIA 1903 S.L.", V2021: 87, V2022: 60, V2023: 50, V2024: 63}
];

// Procesado de datos
years = [2021, 2022, 2023, 2024];
totalMarket = rawData.reduce((acc, curr) => acc + curr.V2024, 0);

dataLong = rawData.flatMap(d => years.map(y => ({
  Empresa: d.Empresa, NIF: d.NIF, Año: y, Ventas: d[`V${y}`]
})));

// Variables Reactivas
mutable currentTab = "overview";
mutable selectedRow = null;
searchWidget = Inputs.search(rawData, {placeholder: "Buscar empresa...", columns: ["Empresa", "NIF"]});
searchTerm = Generators.input(searchWidget);
```

```{ojs}
//| echo: false

// --- 2. INTERFAZ COMPLETA (HTML + Lógica en un solo bloque) ---
htl.html`
<div class="main-wrapper">
  
  <div class="header-section">
    <div>
      <h1 class="page-title">Sector Analytics</h1>
      <div class="page-subtitle">Informe de seguimiento de mercado energético</div>
    </div>
    
    <div class="nav-pills">
      <div class="nav-item ${currentTab === 'overview' ? 'active' : ''}" onclick=${() => mutable currentTab = 'overview'}>
        <i class="fa-solid fa-chart-line"></i> Dashboard
      </div>
      <div class="nav-item ${currentTab === 'data' ? 'active' : ''}" onclick=${() => mutable currentTab = 'data'}>
        <i class="fa-solid fa-database"></i> Datos Detallados
      </div>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-box">
      <div class="kpi-label">Volumen Total 2024</div>
      <div class="kpi-value">${(totalMarket/1000).toLocaleString("es-ES", {maximumFractionDigits:1})} TWh</div>
      <div class="kpi-trend"><i class="fa-solid fa-arrow-trend-up"></i> +2.4% vs 2023</div>
    </div>
    <div class="kpi-box">
      <div class="kpi-label">Empresas Activas</div>
      <div class="kpi-value">${rawData.length}</div>
      <div class="kpi-trend" style="color:#94a3b8"><i class="fa-solid fa-minus"></i> Estable</div>
    </div>
    <div class="kpi-box">
      <div class="kpi-label">Líder de Mercado</div>
      <div class="kpi-value" style="font-size:1.1rem; padding-top:5px;">ENDESA ENERGIA</div>
      <div class="kpi-trend">Cuota dominante</div>
    </div>
  </div>

  <div style="display: ${currentTab === 'overview' ? 'block' : 'none'};">
    <div class="dashboard-card">
      <div class="card-header">
        <h3 class="card-title">Evolución Agregada del Mercado</h3>
        <span class="badge">Actualizado 2024</span>
      </div>
      <div class="card-body">
        ${Plot.plot({
          style: {background: "transparent", color: "#cbd5e1", fontSize: "14px", fontFamily: "Inter"},
          height: 400, marginLeft: 60,
          y: {grid: true, label: "Volumen (GWh)", tickFormat: "s"},
          x: {label: null, tickFormat: "d"},
          marks: [
            Plot.barY(dataLong, Plot.groupX({y: "sum"}, {
              x: "Año", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.8, tip: true, rx: 4
            })),
            Plot.ruleY([0], {stroke: "#334155"})
          ]
        })}
      </div>
    </div>
  </div>

  <div style="display: ${currentTab === 'data' ? 'block' : 'none'};">
    <div class="dashboard-card">
      <div class="card-header" style="background:#1e293b;">
        <div style="flex:1;">${searchWidget}</div>
      </div>
      
      <div style="overflow-x:auto;">
        <table class="custom-table">
          <thead>
            <tr>
              <th style="width:10%">NIF</th>
              <th style="width:40%">Empresa</th>
              <th style="width:15%; text-align:right">2023 (GWh)</th>
              <th style="width:15%; text-align:right">2024 (GWh)</th>
              <th style="width:10%; text-align:center">Tendencia</th>
              <th style="width:10%; text-align:center">Acción</th>
            </tr>
          </thead>
          <tbody>
            ${searchTerm.map(row => {
              const trend = row.V2024 > row.V2023;
              return htl.html`
              <tr>
                <td style="font-family:monospace; color:#94a3b8;">${row.NIF}</td>
                <td style="font-weight:600; color:#fff;">${row.Empresa}</td>
                <td style="text-align:right">${row.V2023.toLocaleString("es-ES")}</td>
                <td style="text-align:right; color:${trend ? '#2dd4bf' : '#cbd5e1'}">${row.V2024.toLocaleString("es-ES")}</td>
                <td style="text-align:center;">
                  <span style="color:${trend ? '#2dd4bf' : '#f43f5e'}">
                    <i class="fa-solid ${trend ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'}"></i>
                  </span>
                </td>
                <td style="text-align:center; display:flex; justify-content:center;">
                  <button class="btn-icon" onclick=${() => mutable selectedRow = row} title="Ver Análisis">
                    <i class="fa-solid fa-chart-simple"></i>
                  </button>
                </td>
              </tr>
            `})}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>`
```

```{ojs}
//| echo: false
// 3. POPUP MODAL (Lógica de detalle)
{
  if (selectedRow) {
    const dialog = htl.html`<dialog class="pro-modal" open>
      <div style="padding:20px 30px; border-bottom:1px solid #334155; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; color:#fff; font-size:1.4rem;">${selectedRow.Empresa}</h2>
          <span class="badge" style="margin-top:5px; display:inline-block;">${selectedRow.NIF}</span>
        </div>
        <button class="close-btn" onclick=${() => mutable selectedRow = null}>&times;</button>
      </div>
      
      <div style="padding:30px;">
        <div id="chart-area" style="margin-bottom:30px;"></div>
        
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px;">
          ${years.map(y => htl.html`
            <div style="background:#0f172a; padding:15px; border-radius:8px; border:1px solid #334155; text-align:center;">
              <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:5px;">Año ${y}</div>
              <div style="font-size:1.1rem; font-weight:700; color:#fff;">
                ${(selectedRow[`V${y}`] || 0).toLocaleString("es-ES")} GWh
              </div>
            </div>
          `)}
        </div>
      </div>
    </dialog>`;

    const chart = Plot.plot({
      style: {background: "transparent", color: "#cbd5e1", fontSize: "14px"},
      height: 300, width: 900, grid: true, marginLeft: 60,
      x: {label: "Año", tickFormat: "d"},
      y: {label: "Ventas (GWh)"},
      marks: [
        Plot.lineY(dataLong.filter(d => d.Empresa === selectedRow.Empresa), {
          x: "Año", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 4, marker: "circle"
        }),
        Plot.areaY(dataLong.filter(d => d.Empresa === selectedRow.Empresa), {
          x: "Año", y: "Ventas", fill: "url(#grad)", fillOpacity: 0.3
        }),
        () => svg`<defs>
          <linearGradient id="grad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#2dd4bf" stop-opacity="0.5"/>
            <stop offset="100%" stop-color="#2dd4bf" stop-opacity="0"/>
          </linearGradient>
        </defs>`
      ]
    });

    dialog.querySelector("#chart-area").append(chart);
    return dialog;
  }
}
```