---
title: "SECTOR ANALYTICS | SPAIN"
page-layout: full
format:
  html:
    toc: false
    css: styles.css
---

<style>
/* Tablas de OJS transparentes y con texto claro */
.observablehq-table { 
  color: #cbd5e1 !important; 
  background: transparent !important; 
  font-family: sans-serif;
  font-size: 0.9rem;
}
.observablehq-table thead th { 
  background-color: rgba(15, 23, 42, 0.8) !important; 
  color: #2dd4bf !important; 
  border-bottom: 1px solid #2dd4bf !important; 
  text-transform: uppercase;
  letter-spacing: 1px;
}
.observablehq-table tbody tr:hover { 
  background-color: rgba(45, 212, 191, 0.1) !important; 
}

/* Inputs (Buscadores y Selectores) */
.observablehq-input { color: #cbd5e1; margin-bottom: 15px; }
.observablehq-input input, .observablehq-input select { 
  background-color: #1e293b !important; 
  color: #fff !important; 
  border: 1px solid #334155 !important;
  padding: 8px 12px; 
  border-radius: 6px;
  outline: none;
}
.observablehq-input input:focus, .observablehq-input select:focus {
  border-color: #2dd4bf !important;
  box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
}

/* Pesta√±as (Tabs) */
.nav-tabs { border-bottom: 1px solid #334155; }
.nav-tabs .nav-link.active { 
  color: #2dd4bf !important; 
  border: none;
  border-bottom: 2px solid #2dd4bf !important; 
  background: transparent !important; 
  font-weight: 600;
}
.nav-tabs .nav-link { 
  color: #94a3b8 !important; 
  border: none;
}
.nav-tabs .nav-link:hover { color: #cbd5e1 !important; }
</style>

```{ojs}
//| echo: false

// 1. CARGA Y LIMPIEZA ROBUSTA DE DATOS
// Leemos el archivo crudo
raw = await FileAttachment("ventas_boe.csv").text()

// Limpiamos l√≠neas: quitamos comillas envolventes y puntos y coma sobrantes
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null; 
  if (l.startsWith('"') && l.endsWith('"')) l = l.slice(1, -1);
  if (l.endsWith(';')) l = l.slice(0, -1);
  return l;
}).filter(l => l !== null).join("\n")

// Parseamos con punto y coma (;)
data = d3.dsvFormat(";").parse(clean_csv, (d) => {
  for (const key in d) {
    // Convertimos columnas de Ventas a n√∫meros (formato espa√±ol 1.234,56 -> 1234.56)
    if (key.includes("Ventas") && d[key]) {
      let val = d[key].toString().replace(/\./g, "").replace(",", ".");
      d[key] = parseFloat(val) || 0;
    }
  }
  return d;
})

// Creamos datos en formato largo para las gr√°ficas temporales
data_long = data.flatMap(d => {
  const years = [2019, 2020, 2021, 2022, 2023, 2024];
  return years.map(year => ({
    "Empresa": d["Raz√≥n Social"],
    "NIF": d["NIF"],
    "A√±o": year,
    "Ventas": d[`Ventas ${year}`] || 0
  }));
})
```

::: {.panel-tabset}

## üëÅÔ∏è‚Äçüó®Ô∏è Market Overview

Visi√≥n consolidada del mercado energ√©tico espa√±ol (Volumen total gestionado).

```{ojs}
//| echo: false
Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "14px", fontFamily: "sans-serif" },
  height: 400,
  marginLeft: 60,
  y: { grid: true, label: "Volumen Total (GWh)", tickFormat: "s" },
  x: { label: null, tickFormat: "d" },
  marks: [
    Plot.barY(data_long, Plot.groupX({y: "sum"}, {
      x: "A√±o", 
      y: "Ventas", 
      fill: "#2dd4bf", // Color Teal corporativo
      fillOpacity: 0.9,
      tip: true,
      title: d => `${d.A√±o}\nTotal: ${d.Ventas}`
    })),
    Plot.ruleY([0], {stroke: "#334155"})
  ]
})
```

## üîç Buscador Inteligente

Base de datos completa de comercializadoras. Busca por nombre o CIF.

```{ojs}
//| echo: false
viewof search = Inputs.search(data, {
  label: "Buscar:",
  placeholder: "Ej: IBERDROLA, ENDESA...",
  columns: ["Raz√≥n Social", "NIF"]
})

Inputs.table(search, {
  columns: ["NIF", "Raz√≥n Social", "Ventas 2022", "Ventas 2023", "Ventas 2024"],
  header: {
    "Raz√≥n Social": "Comercializadora",
    "Ventas 2022": "2022",
    "Ventas 2023": "2023",
    "Ventas 2024": "2024"
  },
  sort: "Ventas 2024",
  reverse: true,
  rows: 15,
  format: {
    "Ventas 2022": x => x.toLocaleString("es-ES", {maximumFractionDigits: 0}) + " GWh",
    "Ventas 2023": x => x.toLocaleString("es-ES", {maximumFractionDigits: 0}) + " GWh",
    "Ventas 2024": x => x.toLocaleString("es-ES", {maximumFractionDigits: 0}) + " GWh"
  }
})
```

## üìà Comparador Competitivo

Selecciona m√∫ltiples empresas para analizar su evoluci√≥n relativa.

```{ojs}
//| echo: false
viewof selected_companies = Inputs.select(data.map(d => d["Raz√≥n Social"]).sort(), {
  label: "A√±adir Competidores:",
  multiple: true,
  value: ["ENDESA ENERGIA, S.A.U.", "IBERDROLA CLIENTES, S.A.U."], 
  unique: true
})

filtered_data = data_long.filter(d => selected_companies.includes(d["Empresa"]))

Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "13px" },
  height: 450,
  marginRight: 140,
  x: { label: "A√±o", tickFormat: "d", domain: [2019, 2024] },
  y: { label: "Ventas (GWh)", grid: true },
  marks: [
    Plot.lineY(filtered_data, {
      x: "A√±o", 
      y: "Ventas", 
      stroke: "Empresa", 
      strokeWidth: 3, 
      marker: "circle",
      curve: "monotone-x", 
      tip: true
    }),
    Plot.text(