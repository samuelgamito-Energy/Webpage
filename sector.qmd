---
title: "SECTOR ANALYTICS"
page-layout: full
echo: false
warning: false
format: 
  html:
    toc: false
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Forzamos el fondo y fuente para evitar herencias rotas del index */
body {
  background-color: #0f172a !important; 
  color: #cbd5e1 !important;
  font-family: 'Segoe UI', sans-serif !important;
}

/* Estructura Dashboard */
.dashboard-wrap { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Tabs */
.nav-pills { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
.nav-item {
  padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-weight: 600;
  border: 1px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
}
.nav-item:hover { background: rgba(45, 212, 191, 0.1); color: #fff; }
.nav-item.active-tab {
  background: #1e293b; color: #2dd4bf; border: 1px solid #2dd4bf;
  box-shadow: 0 4px 10px rgba(45, 212, 191, 0.2);
}

/* Tarjetas */
.dash-card {
  background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; border-radius: 12px;
  padding: 25px; margin-bottom: 25px; backdrop-filter: blur(5px);
}
.d-title { color: #fff; font-size: 1.25rem; font-weight: 700; margin-bottom: 5px; }

/* Tabla */
.t-container { overflow-x: auto; border: 1px solid #334155; border-radius: 8px; }
.d-table { width: 100%; border-collapse: collapse; min-width: 600px; }
.d-table th {
  text-align: left; padding: 15px; background: rgba(15, 23, 42, 0.95);
  color: #2dd4bf; border-bottom: 2px solid #2dd4bf; font-size: 0.85rem; text-transform: uppercase;
}
.d-table td { padding: 12px 15px; border-bottom: 1px solid #334155; color: #e2e8f0; }
.d-table tr:hover { background: rgba(45, 212, 191, 0.05); }

/* Bot칩n Ojo */
.btn-eye {
  background: #0f172a; border: 1px solid #475569; color: #2dd4bf;
  padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;
  display: inline-flex; align-items: center; gap: 5px;
}
.btn-eye:hover { background: #2dd4bf; color: #0f172a; }

/* Modal */
dialog.popup {
  background: #0f172a; color: #fff; border: 1px solid #2dd4bf; border-radius: 15px;
  padding: 0; width: 90%; max-width: 850px;
  box-shadow: 0 0 50px rgba(0,0,0,0.8);
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
}
dialog.popup::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(2px); }
.popup-head { padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
.popup-body { padding: 20px; }
.x-btn { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; }
</style>

```{ojs}
//| echo: false
//| output: false

// DATOS INCRUSTADOS (Blindados)
csvRaw = `NIF;Empresa;Ventas 2021;Ventas 2022;Ventas 2023;Ventas 2024
A81948077;ENDESA ENERGIA, S.A.U.;78500,00;76200,50;74100,20;72050,00
A95758389;IBERDROLA CLIENTES, S.A.U.;65400,00;66800,00;68900,50;70100,00
B82846817;NATURGY IBERIA, S.A.;45200,00;44100,00;43500,00;42800,00
A33005396;TOTALENERGIES MERCADO ESPA칌A S.A.;25000,00;26500,00;28000,00;29500,00
B31737422;ACCIONA GREEN ENERGY DEVELOPMENTS SL;6349,69;7441,37;8334,31;7806,73
B26500231;ADELFAS ENERGIA SL;217,54;108,56;232,80;142,54
B25794207;ADEINNOVA ENERGIA SL;81,59;81,47;73,13;98,64
A87623971;ACSOL ENERGIA GLOBAL SA;45,29;36,31;31,83;28,67
B87177408;ABOUTWHITE SL;52,65;31,25;28,05;32,32
B22350466;AB ENERGIA 1903 S.L.;87,37;60,95;50,00;63,79`;

// PROCESAMIENTO
data = d3.dsvFormat(";").parse(csvRaw, (d) => {
  const row = { "NIF": d.NIF, "Empresa": d.Empresa };
  Object.keys(d).forEach(k => {
    if (k.includes("Ventas")) {
      let year = k.replace("Ventas", "").trim();
      let val = parseFloat(d[k].replace(",", ".")) || 0;
      row[year] = val;
    }
  });
  return row;
})

years = Object.keys(data[0]).filter(k => !isNaN(k)).sort();

data_long = data.flatMap(d => {
  return years.map(year => ({
    "Empresa": d.Empresa, "NIF": d.NIF, "A침o": parseInt(year), "Ventas": d[year] || 0
  }));
})

// Variables Reactivas
mutable currentTab = "comparador"; 
mutable selectedCompany = null;
searchWidget = Inputs.search(data, { placeholder: "游댌 Buscar...", columns: ["Empresa", "NIF"] });
searchTerm = Generators.input(searchWidget);
```

<div class="dashboard-wrap">

  <div class="nav-pills">
    <div class="nav-item ${currentTab === 'mercado' ? 'active-tab' : ''}" onclick=${() => mutable currentTab = 'mercado'}>
      <i class="fa-solid fa-chart-pie"></i> Mercado
    </div>
    <div class="nav-item ${currentTab === 'comparador' ? 'active-tab' : ''}" onclick=${() => mutable currentTab = 'comparador'}>
      <i class="fa-solid fa-table-list"></i> Comparador
    </div>
  </div>

  <div style="display: ${currentTab === 'mercado' ? 'block' : 'none'}">
    <div class="dash-card">
      <div class="d-title">Mercado Global</div>
      <div style="color:#94a3b8; margin-bottom:20px;">Evoluci칩n total del volumen (GWh).</div>
      
      ${Plot.plot({
        style: { background: "transparent", color: "#cbd5e1", fontSize: "14px", fontFamily: "sans-serif" },
        height: 400, marginLeft: 60,
        y: { grid: true, label: "Total GWh", tickFormat: "s" },
        x: { label: null, tickFormat: "d" },
        marks: [
          Plot.barY(data_long, Plot.groupX({y: "sum"}, {
            x: "A침o", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.8, tip: true,
            title: d => `${d.A침o}: ${d.Ventas.toLocaleString("es-ES")}`
          })),
          Plot.ruleY([0], {stroke: "#334155"})
        ]
      })}
    </div>
  </div>

  <div style="display: ${currentTab === 'comparador' ? 'block' : 'none'}">
    <div class="dash-card">
      <div class="d-title">Directorio</div>
      
      <div style="margin-bottom: 20px;">
        ${searchWidget}
      </div>

      <div class="t-container">
        ${htl.html`
        <table class="d-table">
          <thead>
            <tr>
              <th style="width:20%">NIF</th>
              <th style="width:40%">COMERCIALIZADORA</th>
              <th style="width:25%; text-align:right">2024 (GWh)</th>
              <th style="width:15%; text-align:center">VER</th>
            </tr>
          </thead>
          <tbody>
            ${searchTerm.slice(0, 50).map(row => htl.html`
              <tr>
                <td style="font-family:monospace; color:#94a3b8;">${row.NIF}</td>
                <td style="font-weight:600; color:#f1f5f9;">${row.Empresa}</td>
                <td style="text-align:right">
                  ${(row["2024"] || 0).toLocaleString("es-ES", {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                </td>
                <td style="text-align:center">
                  <button class="btn-eye" onclick=${() => mutable selectedCompany = row}>
                    <i class="fa-solid fa-eye"></i>
                  </button>
                </td>
              </tr>
            `)}
          </tbody>
        </table>`}
      </div>
    </div>
  </div>

</div>

${(() => {
  if (selectedCompany) {
    const dialog = htl.html`<dialog class="popup" open>
      <div class="popup-head">
        <h2 style="margin:0; color:#2dd4bf;">${selectedCompany.Empresa}</h2>
        <button class="x-btn" onclick=${() => mutable selectedCompany = null}>&times;</button>
      </div>
      <div class="popup-body">
        <div id="chart-mount"></div>
      </div>
    </dialog>`;

    const chart = Plot.plot({
      style: { background: "transparent", color: "#cbd5e1" },
      height: 300, width: 800, grid: true, marginLeft: 60,
      x: { label: "A침o", tickFormat: "d", domain: years.map(Number) },
      y: { label: "Ventas (GWh)" },
      marks: [
        Plot.lineY(data_long.filter(d => d.Empresa === selectedCompany.Empresa), {
          x: "A침o", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 3, marker: "circle"
        }),
        Plot.areaY(data_long.filter(d => d.Empresa === selectedCompany.Empresa), {
          x: "A침o", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.2
        })
      ]
    });

    dialog.querySelector("#chart-mount").append(chart);
    return dialog;
  }
  return htl.html``;
})()}