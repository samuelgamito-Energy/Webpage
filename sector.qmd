---
title: "SECTOR ANALYTICS"
page-layout: custom
execute:
  echo: false
  warning: false
format:
  html:
    css: styles.css
    toc: false
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body {
  background-color: #0f172a;
  color: #cbd5e1;
  font-family: 'Segoe UI', system-ui, sans-serif;
  margin: 0;
  padding: 0;
}
.main-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 40px 20px;
}

/* Tabs */
.nav-tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
.nav-btn {
  background: rgba(30, 41, 59, 0.5); border: 1px solid transparent; color: #94a3b8;
  padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;
  display: flex; align-items: center; gap: 8px; transition: all 0.2s;
}
.nav-btn:hover { color: #fff; background: rgba(45, 212, 191, 0.1); }
.nav-btn.active {
  background: #1e293b; color: #2dd4bf; border: 1px solid #2dd4bf;
  box-shadow: 0 4px 15px rgba(45, 212, 191, 0.15);
}

/* Cards */
.card-box {
  background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 16px;
  padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px);
  box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
}

/* Tabla */
.table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #334155; }
.data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
.data-table th {
  background: rgba(15, 23, 42, 0.95); color: #2dd4bf; padding: 15px; text-align: left;
  border-bottom: 2px solid #2dd4bf; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
}
.data-table td { padding: 14px 15px; border-bottom: 1px solid #334155; color: #e2e8f0; }
.data-table tr:hover { background: rgba(45, 212, 191, 0.05); }

/* Botones */
.action-btn {
  background: #0f172a; border: 1px solid #475569; color: #2dd4bf;
  padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;
}
.action-btn:hover { background: #2dd4bf; color: #0f172a; }

/* Popup */
dialog.chart-popup {
  background: #0f172a; color: #fff; border: 1px solid #2dd4bf; border-radius: 16px;
  padding: 0; width: 90%; max-width: 900px; position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%); box-shadow: 0 0 50px rgba(0,0,0,0.9);
}
dialog.chart-popup::backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
</style>

```{ojs}
//| echo: false

// 1. DATOS SEGUROS
rawData = [
  {NIF: "A81948077", Empresa: "ENDESA ENERGIA, S.A.U.", V2021: 78500, V2022: 76200, V2023: 74100, V2024: 72050},
  {NIF: "A95758389", Empresa: "IBERDROLA CLIENTES, S.A.U.", V2021: 65400, V2022: 66800, V2023: 68900, V2024: 70100},
  {NIF: "B82846817", Empresa: "NATURGY IBERIA, S.A.", V2021: 45200, V2022: 44100, V2023: 43500, V2024: 42800},
  {NIF: "A33005396", Empresa: "TOTALENERGIES MERCADO ESPAÑA", V2021: 25000, V2022: 26500, V2023: 28000, V2024: 29500},
  {NIF: "B31737422", Empresa: "ACCIONA GREEN ENERGY", V2021: 6349, V2022: 7441, V2023: 8334, V2024: 7806},
  {NIF: "B26500231", Empresa: "ADELFAS ENERGIA SL", V2021: 217, V2022: 108, V2023: 232, V2024: 142},
  {NIF: "B25794207", Empresa: "ADEINNOVA ENERGIA SL", V2021: 81, V2022: 81, V2023: 73, V2024: 98},
  {NIF: "A87623971", Empresa: "ACSOL ENERGIA GLOBAL SA", V2021: 45, V2022: 36, V2023: 31, V2024: 28},
  {NIF: "B87177408", Empresa: "ABOUTWHITE SL", V2021: 52, V2022: 31, V2023: 28, V2024: 32},
  {NIF: "B22350466", Empresa: "AB ENERGIA 1903 S.L.", V2021: 87, V2022: 60, V2023: 50, V2024: 63}
];

// Procesar para gráficas
years = [2021, 2022, 2023, 2024];
dataLong = rawData.flatMap(d => years.map(y => ({
  Empresa: d.Empresa, NIF: d.NIF, Año: y, Ventas: d[`V${y}`]
})));

// Variables Reactivas
mutable currentTab = "comparador";
mutable selectedRow = null;
searchWidget = Inputs.search(rawData, {placeholder: "Buscar empresa...", columns: ["Empresa", "NIF"]});
searchTerm = Generators.input(searchWidget);
```

```{ojs}
//| echo: false
// 2. INTERFAZ GRÁFICA (Toda generada aquí para evitar errores)
htl.html`
<div class="main-container">
  
  <div class="nav-tabs">
    <div class="nav-btn ${currentTab === 'mercado' ? 'active' : ''}" onclick=${() => mutable currentTab = 'mercado'}>
      <i class="fa-solid fa-chart-pie"></i> Mercado Global
    </div>
    <div class="nav-btn ${currentTab === 'comparador' ? 'active' : ''}" onclick=${() => mutable currentTab = 'comparador'}>
      <i class="fa-solid fa-list-check"></i> Comparador
    </div>
  </div>

  <div style="display: ${currentTab === 'mercado' ? 'block' : 'none'};">
    <div class="card-box">
      <h2 style="color:#fff; margin-top:0;">Evolución del Mercado</h2>
      <p style="color:#94a3b8;">Volumen total agregado (GWh)</p>
      ${Plot.plot({
        style: {background: "transparent", color: "#cbd5e1", fontSize: "14px"},
        height: 400, marginLeft: 60,
        y: {grid: true, label: "Total GWh", tickFormat: "s"},
        marks: [
          Plot.barY(dataLong, Plot.groupX({y: "sum"}, {x: "Año", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.8, tip: true})),
          Plot.ruleY([0], {stroke: "#334155"})
        ]
      })}
    </div>
  </div>

  <div style="display: ${currentTab === 'comparador' ? 'block' : 'none'};">
    <div class="card-box">
      <h2 style="color:#fff; margin-top:0;">Directorio de Empresas</h2>
      <div style="margin-bottom: 20px;">${searchWidget}</div>
      
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>NIF</th>
              <th>EMPRESA</th>
              <th style="text-align:right">2024 (GWh)</th>
              <th style="text-align:center">ACCIÓN</th>
            </tr>
          </thead>
          <tbody>
            ${searchTerm.map(row => htl.html`
              <tr>
                <td style="font-family:monospace; color:#94a3b8;">${row.NIF}</td>
                <td style="font-weight:600; color:#f1f5f9;">${row.Empresa}</td>
                <td style="text-align:right">${row.V2024.toLocaleString("es-ES")}</td>
                <td style="text-align:center">
                  <button class="action-btn" onclick=${() => mutable selectedRow = row}>
                    <i class="fa-solid fa-eye"></i> Ver
                  </button>
                </td>
              </tr>
            `)}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>`
```

```{ojs}
//| echo: false
// 3. POPUP MODAL
{
  if (selectedRow) {
    const dialog = htl.html`<dialog class="chart-popup" open>
      <div style="padding:20px; border-bottom:1px solid #334155; display:flex; justify-content:space-between; align-items:center; background:rgba(30,41,59,0.5);">
        <h2 style="margin:0; color:#2dd4bf;">${selectedRow.Empresa}</h2>
        <button style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;" onclick=${() => mutable selectedRow = null}>&times;</button>
      </div>
      <div style="padding:30px;">
        <div id="chart-area"></div>
      </div>
    </dialog>`;

    const chart = Plot.plot({
      style: {background: "transparent", color: "#cbd5e1"},
      height: 350, width: 850, grid: true, marginLeft: 60,
      x: {label: "Año", tickFormat: "d"},
      y: {label: "Ventas (GWh)"},
      marks: [
        Plot.lineY(dataLong.filter(d => d.Empresa === selectedRow.Empresa), {x: "Año", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 3, marker: "circle"}),
        Plot.areaY(dataLong.filter(d => d.Empresa === selectedRow.Empresa), {x: "Año", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.2})
      ]
    });

    dialog.querySelector("#chart-area").append(chart);
    return dialog;
  }
}
```