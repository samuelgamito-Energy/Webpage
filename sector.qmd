---
title: "SECTOR ANALYTICS"
page-layout: full
format:
  html:
    toc: false
    css: styles.css
---

<style>
/* 1. CONTENEDOR PRINCIPAL */
.dashboard-container {
  font-family: 'Segoe UI', system-ui, sans-serif;
  color: #cbd5e1;
  max-width: 1400px;
  margin: 0 auto;
}

/* 2. SISTEMA DE PESTA√ëAS (Estilo Bot√≥n como en tu HTML) */
.tab-nav {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 1px solid #334155;
  padding-bottom: 10px;
}
.tab-btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid transparent;
  background: transparent;
  color: #94a3b8;
  transition: all 0.2s;
}
.tab-btn:hover { color: #fff; background: rgba(30, 41, 59, 0.5); }
.tab-btn.active {
  background-color: #1e293b;
  color: #2dd4bf;
  border-color: #2dd4bf;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* 3. TARJETAS (CARDS) */
.card {
  background-color: rgba(30, 41, 59, 0.4);
  border: 1px solid #334155;
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

/* 4. TABLA PERSONALIZADA (Id√©ntica a tu HTML) */
.fnee-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
}
.fnee-table th {
  text-align: left;
  padding: 12px 15px;
  color: #2dd4bf;
  border-bottom: 2px solid #2dd4bf;
  text-transform: uppercase;
  font-size: 0.8rem;
  letter-spacing: 1px;
}
.fnee-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #334155;
  color: #e2e8f0;
}
.fnee-table tr:hover {
  background-color: rgba(45, 212, 191, 0.05);
}

/* 5. BOT√ìN DE ACCI√ìN (OJO) */
.btn-action {
  background: #0f172a;
  border: 1px solid #475569;
  color: #2dd4bf;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  display: inline-flex; align-items: center; gap: 5px;
  transition: all 0.2s;
}
.btn-action:hover {
  background: #2dd4bf; color: #0f172a; border-color: #2dd4bf;
}

/* 6. MODAL / POPUP */
dialog.modal {
  background: #0f172a;
  color: #fff;
  border: 1px solid #2dd4bf;
  border-radius: 15px;
  padding: 0;
  width: 80%; max-width: 900px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}
dialog.modal::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
.modal-header { padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; background: rgba(30,41,59,0.5); }
.modal-body { padding: 30px; }
.close-modal { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; }
.close-modal:hover { color: #fff; }

/* 7. INPUTS */
input[type="search"] {
  width: 100%;
  padding: 12px;
  background: #0f172a;
  border: 1px solid #334155;
  color: #fff;
  border-radius: 8px;
  outline: none;
}
input[type="search"]:focus { border-color: #2dd4bf; }
</style>

```{ojs}
//| echo: false

// 1. CARGA DE DATOS
raw = await FileAttachment("ventas_boe.csv").text()

// Limpieza (Comillas y puntos y coma)
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null;
  if (l.startsWith('"') && l.endsWith('"')) l = l.slice(1, -1);
  if (l.endsWith(';')) l = l.slice(0, -1);
  return l;
}).filter(l => l !== null).join("\n")

// Parseo Inteligente
data = d3.dsvFormat(";").parse(clean_csv, (d, i, columns) => {
  const row = {
    "NIF": d[columns[0]],       
    "Empresa": d[columns[1]]    
  };

  columns.forEach(col => {
    if (col.includes("Ventas")) {
      let valStr = d[col] ? d[col].toString() : "0";
      let val = parseFloat(valStr.replace(/\./g, "").replace(",", ".")) || 0;
      let year = col.replace("Ventas", "").trim();
      row[year] = val; 
    }
  });
  return row;
})

// Lista de a√±os (Excluyendo 2025 expl√≠citamente)
years = Object.keys(data[0])
  .filter(k => !isNaN(k) && k.length === 4 && k !== "2025")
  .sort();

// Datos Largos para gr√°ficas
data_long = data.flatMap(d => {
  return years.map(year => ({
    "Empresa": d["Empresa"],
    "NIF": d["NIF"],
    "A√±o": parseInt(year),
    "Ventas": d[year] || 0
  }));
})

// VARIABLES DE ESTADO (Para la interactividad)
mutable activeTab = "comparador"; // Pesta√±a activa por defecto
mutable selectedCompany = null;   // Empresa seleccionada para el popup
```

<div class="dashboard-container">

  <div class="tab-nav">
    <button class="tab-btn ${activeTab === 'mercado' ? 'active' : ''}" onclick=${() => mutable activeTab = 'mercado'}>
      <i class="fa-solid fa-chart-pie"></i> Mercado Global
    </button>
    <button class="tab-btn ${activeTab === 'comparador' ? 'active' : ''}" onclick=${() => mutable activeTab = 'comparador'}>
      <i class="fa-solid fa-list"></i> Comparador y Datos
    </button>
  </div>

  <div style="display: ${activeTab === 'mercado' ? 'block' : 'none'}">
    <div class="card">
      <h3 style="color:#2dd4bf; margin-top:0;">Evoluci√≥n Total del Mercado</h3>
      <p style="color:#94a3b8; font-size:0.9rem;">Volumen agregado de todas las comercializadoras (GWh).</p>
      
      ${Plot.plot({
        style: { background: "transparent", color: "#cbd5e1", fontSize: "14px" },
        height: 400,
        marginLeft: 60,
        y: { grid: true, label: "Total GWh", tickFormat: "s" },
        x: { label: null, tickFormat: "d" },
        marks: [
          Plot.barY(data_long, Plot.groupX({y: "sum"}, {
            x: "A√±o", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.8, tip: true
          }))
        ]
      })}
    </div>
  </div>

  <div style="display: ${activeTab === 'comparador' ? 'block' : 'none'}">
    <div class="card">
      <div style="margin-bottom: 20px;">
        <h3 style="margin:0; color:#fff;">Directorio de Comercializadoras</h3>
      </div>

      <div style="margin-bottom: 20px;">
        ${viewof searchTerm = Inputs.search(data, {
          placeholder: "üîç Buscar por NIF o Raz√≥n Social...",
          columns: ["Empresa", "NIF"]
        })}
      </div>

      ${htl.html`<div style="overflow-x: auto;">
        <table class="fnee-table">
          <thead>
            <tr>
              <th style="width:15%">NIF</th>
              <th style="width:45%">COMERCIALIZADORA</th>
              <th style="width:25%; text-align:right">VENTAS 2024 (GWh)</th>
              <th style="width:15%; text-align:center">AN√ÅLISIS</th>
            </tr>
          </thead>
          <tbody>
            ${searchTerm.slice(0, 50).map(row => htl.html`
              <tr>
                <td style="font-family:monospace; color:#94a3b8;">${row.NIF}</td>
                <td style="font-weight:600; color:#f1f5f9;">${row.Empresa}</td>
                <td style="text-align:right">
                  ${(row["2024"] || 0).toLocaleString("es-ES", {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </td>
                <td style="text-align:center">
                  <button class="btn-action" onclick=${() => mutable selectedCompany = row}>
                    üëÅÔ∏è Ver
                  </button>
                </td>
              </tr>
            `)}
          </tbody>
        </table>
        ${searchTerm.length === 0 ? htl.html`<div style="padding:20px; text-align:center">No hay resultados</div>` : ''}
      </div>`}
      
      <div style="margin-top:10px; text-align:right; font-size:0.8rem; color:#64748b;">
        Resultados: ${searchTerm.length}
      </div>
    </div>
  </div>

</div>

${(() => {
  if (selectedCompany) {
    const dialog = htl.html`<dialog class="modal" open>
      <div class="modal-header">
        <div>
          <h2 style="margin:0; color:#2dd4bf">${selectedCompany.Empresa}</h2>
          <span style="font-family:monospace; color:#94a3b8">${selectedCompany.NIF}</span>
        </div>
        <button class="close-modal" onclick=${() => mutable selectedCompany = null}>&times;</button>
      </div>
      <div class="modal-body">
        <div id="chart-area"></div>
      </div>
    </dialog>`;

    // Gr√°fico dentro del modal
    const chart = Plot.plot({
      style: { background: "transparent", color: "#cbd5e1" },
      height: 300,
      width: 800,
      grid: true,
      x: { label: "A√±o", tickFormat: "d", domain: years.map(Number) },
      y: { label: "Ventas (GWh)" },
      marks: [
        Plot.lineY(data_long.filter(d => d.Empresa === selectedCompany.Empresa), {
          x: "A√±o", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 3, marker: "circle", tip: true
        }),
        Plot.areaY(data_long.filter(d => d.Empresa === selectedCompany.Empresa), {
          x: "A√±o", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.2
        })
      ]
    });

    dialog.querySelector("#chart-area").append(chart);
    
    // Cerrar al hacer click fuera
    dialog.addEventListener("click", e => {
      const rect = dialog.getBoundingClientRect();
      if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
        mutable selectedCompany = null;
      }
    });

    return dialog;
  }
  return htl.html``;
})()}