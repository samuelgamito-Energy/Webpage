---
title: "SECTOR ANALYTICS"
page-layout: full
format:
  html:
    toc: false
    css: styles.css
---

<style>
/* 1. ESTRUCTURA BASE */
.observablehq { 
  font-family: 'Inter', system-ui, sans-serif; 
  color: #cbd5e1; 
}

/* 2. TARJETAS (CARDS) - Estilo Dashboard */
.dashboard-card {
  background-color: rgba(30, 41, 59, 0.5); /* Fondo semitransparente oscuro */
  border: 1px solid #334155;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
}

/* 3. TABLA PROFESIONAL INTERACTIVA */
.pro-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.9rem;
}
.pro-table thead th {
  background-color: #0f172a;
  color: #2dd4bf;
  padding: 12px 15px;
  text-align: left;
  border-bottom: 2px solid #2dd4bf;
  text-transform: uppercase;
  font-size: 0.8rem;
  letter-spacing: 0.05em;
  position: sticky;
  top: 0;
}
.pro-table tbody tr {
  transition: all 0.2s ease;
  border-bottom: 1px solid #334155;
}
.pro-table tbody tr:hover {
  background-color: rgba(45, 212, 191, 0.1); /* Hover Teal suave */
  transform: translateX(5px);
}
.pro-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #1e293b;
  color: #e2e8f0;
}

/* 4. BOTONES DE ACCI√ìN (El "Ojo") */
.btn-view {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background-color: transparent;
  border: 1px solid #475569;
  color: #2dd4bf;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s;
}
.btn-view:hover {
  background-color: #2dd4bf;
  color: #0f172a;
  box-shadow: 0 0 10px rgba(45, 212, 191, 0.3);
  border-color: #2dd4bf;
}

/* 5. VENTANA MODAL (POPUP) */
dialog.chart-modal {
  background: #1e293b;
  color: #fff;
  border: 1px solid #2dd4bf;
  border-radius: 16px;
  padding: 0; /* Padding controlado dentro */
  width: 90%;
  max-width: 900px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
}
dialog.chart-modal::backdrop {
  background: rgba(15, 23, 42, 0.8); /* Fondo desenfocado oscuro */
  backdrop-filter: blur(4px);
}
.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 20px;
  border-bottom: 1px solid #334155;
  background: rgba(15, 23, 42, 0.5);
}
.modal-body { padding: 20px; }
.btn-close {
  background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;
}
.btn-close:hover { color: #fff; }

/* 6. INPUTS Y PESTA√ëAS */
input[type="search"] {
  background: #0f172a !important;
  border: 1px solid #334155 !important;
  color: #fff !important;
  padding: 10px !important;
  border-radius: 8px !important;
  width: 100%;
}
.nav-tabs { border-bottom: 1px solid #334155; }
.nav-tabs .nav-link.active {
  background: transparent !important;
  border-bottom: 3px solid #2dd4bf !important;
  color: #2dd4bf !important;
  font-weight: 700;
}
.nav-tabs .nav-link { color: #94a3b8; }
</style>

```{ojs}
//| echo: false

// --- 1. CARGA Y LIMPIEZA DE DATOS ---
raw = await FileAttachment("ventas_boe.csv").text()

// Limpieza robusta (Quitar comillas, puntos y coma finales)
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null;
  if (l.startsWith('"') && l.endsWith('"')) l = l.slice(1, -1);
  if (l.endsWith(';')) l = l.slice(0, -1);
  return l;
}).filter(l => l !== null).join("\n")

// Parseo Inteligente
data = d3.dsvFormat(";").parse(clean_csv, (d, i, columns) => {
  const row = {
    "NIF": d[columns[0]],       // 1¬™ Columna = NIF
    "Empresa": d[columns[1]]    // 2¬™ Columna = Nombre
  };

  // Detectar columnas de a√±os
  columns.forEach(col => {
    if (col.includes("Ventas")) {
      let valStr = d[col] ? d[col].toString() : "0";
      // Formato espa√±ol 1.234,56 -> 1234.56
      let val = parseFloat(valStr.replace(/\./g, "").replace(",", ".")) || 0;
      let year = col.replace("Ventas", "").trim();
      row[year] = val; 
    }
  });
  return row;
})

// Filtrar a√±os v√°lidos y QUITAR 2025
years = Object.keys(data[0])
  .filter(k => !isNaN(k) && k.length === 4 && k !== "2025")
  .sort();

// Datos en formato largo para gr√°ficas
data_long = data.flatMap(d => {
  return years.map(year => ({
    "Empresa": d["Empresa"],
    "NIF": d["NIF"],
    "A√±o": parseInt(year),
    "Ventas": d[year] || 0
  }));
})

// Estado Reactivo para el Popup
mutable selectedCompany = null;
```

::: {.panel-tabset}

## üìä Mercado Global

<div class="dashboard-card">
  <h3 style="color: #2dd4bf; margin-top:0;">Evoluci√≥n del Volumen Total</h3>
  <p style="font-size: 0.9rem; color: #94a3b8;">Suma agregada de ventas (GWh) de todas las comercializadoras activas.</p>
  
```{ojs}
//| echo: false
Plot.plot({
  style: { background: "transparent", color: "#cbd5e1", fontSize: "14px" },
  height: 350,
  marginLeft: 60,
  y: { grid: true, label: "Total GWh", tickFormat: "s" },
  x: { label: null, tickFormat: "d" },
  marks: [
    Plot.barY(data_long, Plot.groupX({y: "sum"}, {
      x: "A√±o", 
      y: "Ventas", 
      fill: "#2dd4bf", 
      fillOpacity: 0.8,
      tip: true,
      title: d => `${d.A√±o}: ${d.Ventas.toLocaleString("es-ES")} GWh`
    })),
    Plot.ruleY([0], {stroke: "#475569"})
  ]
})
```
</div>

## üîç Comparador Avanzado

<div class="dashboard-card">
  <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
    <div style="flex: 1;">
      <h3 style="color: #fff; margin:0;">Directorio de Comercializadoras</h3>
      <p style="color: #64748b; margin:0; font-size: 0.9rem;">Busca y analiza el hist√≥rico individual.</p>
    </div>
  </div>

```{ojs}
//| echo: false
// 1. Buscador Reactivo
viewof searchTerm = Inputs.search(data, {
  placeholder: "Escribe nombre o NIF (ej: ENDESA, B82...)",
  columns: ["Empresa", "NIF"]
})

// 2. Tabla HTML Personalizada (Replica el dise√±o que te gusta)
htl.html`<div style="overflow-x: auto; border-radius: 8px; border: 1px solid #334155;">
  <table class="pro-table">
    <thead>
      <tr>
        <th style="width: 15%">NIF</th>
        <th style="width: 45%">COMERCIALIZADORA</th>
        <th style="width: 25%; text-align: right">VENTAS 2024 (GWh)</th>
        <th style="width: 15%; text-align: center">AN√ÅLISIS</th>
      </tr>
    </thead>
    <tbody>
      ${searchTerm.slice(0, 50).map(row => htl.html`
        <tr>
          <td style="font-family: monospace; color: #94a3b8;">${row.NIF}</td>
          <td style="font-weight: 600; color: #f1f5f9;">${row.Empresa}</td>
          <td style="text-align: right; font-feature-settings: 'tnum';">
            ${(row["2024"] || 0).toLocaleString("es-ES", {minimumFractionDigits: 2, maximumFractionDigits: 2})}
          </td>
          <td style="text-align: center">
            <button class="btn-view" onclick=${() => { mutable selectedCompany = row; }}>
              üëÅÔ∏è Ver
            </button>
          </td>
        </tr>
      `)}
    </tbody>
  </table>
  ${searchTerm.length === 0 ? htl.html`<div style="padding:20px; text-align:center; color:#64748b;">No se encontraron resultados</div>` : ''}
</div>
<div style="margin-top: 10px; text-align: right; color: #64748b; font-size: 0.8rem;">
  Mostrando ${Math.min(50, searchTerm.length)} de ${data.length} empresas
</div>`
```
</div>

:::

```{ojs}
//| echo: false
{
  if (selectedCompany) {
    const dialog = htl.html`<dialog class="chart-modal" open>
      <div class="modal-header">
        <div>
          <h2 style="color: #2dd4bf; margin: 0; font-size: 1.2rem;">${selectedCompany.Empresa}</h2>
          <span style="color: #94a3b8; font-size: 0.9rem; font-family: monospace;">${selectedCompany.NIF}</span>
        </div>
        <button class="btn-close" onclick=${() => dialog.close()}>&times;</button>
      </div>
      
      <div class="modal-body">
        <div id="chart-container"></div>
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; text-align: center;">
          ${years.map(y => htl.html`
            <div style="background: rgba(15, 23, 42, 0.5); padding: 10px; border-radius: 8px; border: 1px solid #334155;">
              <div style="color: #64748b; font-size: 0.8rem;">${y}</div>
              <div style="color: #fff; font-weight: bold;">
                ${(selectedCompany[y] || 0).toLocaleString("es-ES", {maximumFractionDigits: 0})}
              </div>
            </div>
          `)}
        </div>
      </div>
    </dialog>`;

    // Insertar gr√°fico en el modal
    const chart = Plot.plot({
      style: { background: "transparent", color: "#cbd5e1", fontSize: "13px" },
      height: 300,
      width: 800,
      marginLeft: 60,
      grid: true,
      x: { label: "A√±o", tickFormat: "d", domain: years.map(Number) },
      y: { label: "Ventas (GWh)" },
      marks: [
        Plot.lineY(data_long.filter(d => d.Empresa === selectedCompany.Empresa), {
          x: "A√±o", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 3, marker: "circle", curve: "monotone-x", tip: true
        }),
        Plot.areaY(data_long.filter(d => d.Empresa === selectedCompany.Empresa), {
          x: "A√±o", y: "Ventas", fill: "url(#gradient)", fillOpacity: 0.3
        }),
        // Gradiente Teal
        () => svg`<defs>
          <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#2dd4bf" stop-opacity="0.5"/>
            <stop offset="100%" stop-color="#2dd4bf" stop-opacity="0"/>
          </linearGradient>
        </defs>`
      ]
    });

    dialog.querySelector("#chart-container").append(chart);
    dialog.addEventListener("close", () => { mutable selectedCompany = null; });
    document.body.append(dialog);
    
    // Cerrar al hacer clic fuera
    dialog.addEventListener("click", e => {
      const rect = dialog.getBoundingClientRect();
      if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
        dialog.close();
      }
    });

    return dialog;
  }
}
```