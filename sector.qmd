---
title: "Sector Analytics"
page-layout: full
format:
  html:
    toc: true
---

```{ojs}
//| echo: false

// 1. CARGA DE DATOS SEGURA
// Leemos el archivo crudo para quitar las comillas extra침as que trae
raw = await FileAttachment("ventas_boe.csv").text()

// 2. LIMPIEZA DE FORMATO (L칤nea a l칤nea)
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null; 
  
  // Si la l칤nea est치 entre comillas dobles, las quitamos
  if (l.startsWith('"') && l.endsWith('"')) {
    l = l.slice(1, -1);
  }
  
  // Si sobra un punto y coma al final, lo quitamos
  if (l.endsWith(';')) {
    l = l.slice(0, -1);
  }
  
  return l;
}).filter(l => l !== null).join("\n")

// 3. PARSEO Y CONVERSI칍N NUM칄RICA
data = d3.dsvFormat(";").parse(clean_csv, (d) => {
  for (const key in d) {
    // Detectamos columnas de Ventas
    if (key.includes("Ventas") && d[key]) {
      // Formato espa침ol: 1.000,00 -> 1000.00
      let val = d[key].toString()
                     .replace(/\./g, "")   // Quitar puntos de miles
                     .replace(",", ".");   // Cambiar coma por punto decimal
      d[key] = parseFloat(val) || 0;
    }
  }
  return d;
})

// 4. DATOS FORMATO LARGO (Para gr치ficas)
data_long = data.flatMap(d => {
  // Ajusta estos a침os seg칰n las columnas reales de tu CSV
  const years = [2019, 2020, 2021, 2022, 2023, 2024];
  return years.map(year => ({
    "Empresa": d["Raz칩n Social"],
    "NIF": d["NIF"],
    "A침o": year,
    "Ventas": d[`Ventas ${year}`] || 0
  }));
})
```

# Market Intelligence

::: {.panel-tabset}

## 游댌 Buscador y Datos

Consulta el hist칩rico por Empresa o NIF. (Datos en GWh)

```{ojs}
//| echo: false
viewof search = Inputs.search(data, {
  label: "Buscar:",
  placeholder: "Ej: ENDESA, B82...",
  columns: ["Raz칩n Social", "NIF"]
})

Inputs.table(search, {
  columns: ["NIF", "Raz칩n Social", "Ventas 2022", "Ventas 2023", "Ventas 2024"],
  header: {
    "Raz칩n Social": "Comercializadora",
    "Ventas 2022": "2022 (GWh)",
    "Ventas 2023": "2023 (GWh)",
    "Ventas 2024": "2024 (GWh)"
  },
  sort: "Ventas 2024",
  reverse: true,
  rows: 15,
  format: {
    "Ventas 2022": x => x.toLocaleString("es-ES", {minimumFractionDigits: 2, maximumFractionDigits: 2}),
    "Ventas 2023": x => x.toLocaleString("es-ES", {minimumFractionDigits: 2, maximumFractionDigits: 2}),
    "Ventas 2024": x => x.toLocaleString("es-ES", {minimumFractionDigits: 2, maximumFractionDigits: 2})
  }
})
```

## 游늵 Mercado Global

Evoluci칩n del volumen total (suma de todas las comercializadoras).

```{ojs}
//| echo: false
Plot.plot({
  title: "Evoluci칩n del Mercado (GWh)",
  marks: [
    Plot.barY(data_long, Plot.groupX({y: "sum"}, {x: "A침o", y: "Ventas", fill: "#2dd4bf", tip: true})),
    Plot.ruleY([0])
  ],
  y: { label: "GWh Totales", grid: true, tickFormat: "s" },
  x: { label: "A침o", tickFormat: "d" },
  color: { legend: false },
  style: { fontSize: "14px", fontFamily: "sans-serif" },
  marginLeft: 60
})
```

## 游 Comparador

Compara la curva de ventas entre competidores.

```{ojs}
//| echo: false
// Selector m칰ltiple de empresas
viewof selected_companies = Inputs.select(data.map(d => d["Raz칩n Social"]).sort(), {
  label: "Selecciona Empresas:",
  multiple: true,
  value: ["ENDESA ENERGIA, S.A.U.", "IBERDROLA CLIENTES, S.A.U."], 
  unique: true
})

// Filtramos datos seg칰n selecci칩n
filtered_data = data_long.filter(d => selected_companies.includes(d["Empresa"]))

Plot.plot({
  title: "Comparativa (GWh)",
  marks: [
    Plot.lineY(filtered_data, {
      x: "A침o", 
      y: "Ventas", 
      stroke: "Empresa", 
      strokeWidth: 3, 
      marker: true,
      tip: true
    }),
    Plot.text(filtered_data, Plot.selectLast({
      x: "A침o", 
      y: "Ventas", 
      z: "Empresa", 
      text: "Empresa", 
      textAnchor: "start", 
      dx: 10
    }))
  ],
  x: { label: "A침o", tickFormat: "d", domain: [2019, 2024] },
  y: { label: "GWh", grid: true },
  color: { legend: true },
  marginRight: 120, // Espacio para etiquetas a la derecha
  style: { fontSize: "12px" }
})
```

:::