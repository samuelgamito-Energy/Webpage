---
title: "SECTOR ANALYTICS"
page-layout: full
format:
  html:
    toc: false
    css: styles.css
---

<style>
.observablehq { color: #cbd5e1 !important; font-family: 'Inter', sans-serif; }
.observablehq-table { color: #cbd5e1 !important; background: transparent !important; }
.observablehq-table thead { background-color: rgba(15, 23, 42, 0.9) !important; border-bottom: 2px solid #2dd4bf !important; }
.observablehq-table th { color: #2dd4bf !important; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
.observablehq-table tr:hover { background-color: rgba(45, 212, 191, 0.1) !important; }
form.observablehq-input input, form.observablehq-input select { background-color: #1e293b !important; border: 1px solid #334155 !important; color: #f1f5f9 !important; border-radius: 6px; padding: 8px 12px; }
.nav-tabs { border-bottom: 1px solid #334155; margin-bottom: 20px; }
.nav-tabs .nav-link.active { background-color: transparent; border-bottom: 3px solid #2dd4bf; color: #2dd4bf; font-weight: bold; }
.nav-tabs .nav-link { color: #94a3b8; border: none; }
</style>

```{ojs}
//| echo: false

// 1. CARGA SEGURA
raw = await FileAttachment("ventas_boe.csv").text()

// 2. LIMPIEZA DE ESTRUCTURA (Quitar comillas envolventes)
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null;
  // Si la l칤nea entera est치 entre comillas, las quitamos
  if (l.startsWith('"') && l.endsWith('"')) l = l.slice(1, -1);
  // Si termina en punto y coma, lo quitamos para que no cree una columna vac칤a
  if (l.endsWith(';')) l = l.slice(0, -1);
  return l;
}).filter(l => l !== null).join("\n")

// 3. PARSEO DIN츼MICO (SIN ASUMIR NOMBRES DE COLUMNAS)
data = d3.dsvFormat(";").parse(clean_csv, (d, i, columns) => {
  // columns es la lista de encabezados detectados (ej: NIF, Raz칩n Social, Ventas 2019...)
  
  // Mapeo seguro por 칈NDICE (para evitar errores de tildes en "Raz칩n")
  const nif = d[columns[0]]; 
  const nombre = d[columns[1]];
  
  const row = {
    "NIF": nif,
    "Empresa": nombre
  };

  // Detectar autom치ticamente columnas de a침os
  columns.forEach(col => {
    if (col.includes("Ventas")) {
      // Limpiar numero espa침ol (1.000,00 -> 1000.00)
      let valStr = d[col] ? d[col].toString() : "0";
      let val = parseFloat(valStr.replace(/\./g, "").replace(",", ".")) || 0;
      
      // Guardamos el a침o limpio (ej: "Ventas 2022" -> "2022")
      let year = col.replace("Ventas", "").trim();
      row[`Ventas ${year}`] = val; // Guardamos como "Ventas 2022" para la tabla
      row[year] = val; // Guardamos como "2022" para facilitar l칩gica
    }
  });
  
  return row;
})

// 4. DETECTAR A칌OS DISPONIBLES AUTOM츼TICAMENTE
// Miramos la primera fila para ver qu칠 a침os existen realmente en el archivo
years_found = Object.keys(data[0])
  .filter(k => !isNaN(k) && k.length === 4) // Filtra solo claves que sean a침os (2019, 2020...)
  .sort();

// 5. DATOS FORMATO LARGO (Para gr치ficas)
data_long = data.flatMap(d => {
  return years_found.map(year => ({
    "Empresa": d["Empresa"],
    "NIF": d["NIF"],
    "A침o": parseInt(year),
    "Ventas": d[year] || 0
  }));
})
```

::: {.panel-tabset}

## 游댌 Buscador

Base de datos oficial. (A침os detectados: ${years_found.join(", ")})

```{ojs}
//| echo: false
viewof search = Inputs.search(data, {
  label: "Buscar:",
  placeholder: "Empresa o NIF...",
  columns: ["Empresa", "NIF"]
})

// Tabla Din치mica: Muestra solo las columnas que existen en el CSV
Inputs.table(search, {
  columns: ["NIF", "Empresa", ...years_found.map(y => `Ventas ${y}`).reverse()], 
  header: {
    "Empresa": "Comercializadora",
    // Mapeamos din치micamente las cabeceras
    ...Object.fromEntries(years_found.map(y => [`Ventas ${y}`, `${y}`]))
  },
  sort: `Ventas ${years_found[years_found.length-1]}`, // Ordenar por el 칰ltimo a침o disponible
  reverse: true,
  rows: 15,
  format: Object.fromEntries(years_found.map(y => [
    `Ventas ${y}`, x => x.toLocaleString("es-ES", {maximumFractionDigits: 0})
  ]))
})
```

## 游늵 Mercado Global

Volumen total.

```{ojs}
//| echo: false
Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "14px" },
  height: 400,
  marginLeft: 60,
  y: { grid: true, label: "Total GWh", tickFormat: "s" },
  x: { label: null, tickFormat: "d" },
  marks: [
    Plot.barY(data_long, Plot.groupX({y: "sum"}, {
      x: "A침o", 
      y: "Ventas", 
      fill: "#2dd4bf", 
      fillOpacity: 0.8,
      tip: true,
      title: d => `${d.A침o}: ${d.Ventas.toLocaleString("es-ES")} GWh`
    })),
    Plot.ruleY([0], {stroke: "#475569"})
  ]
})
```

## 游 Comparador

```{ojs}
//| echo: false
viewof selected_companies = Inputs.select(data.map(d => d["Empresa"]).sort(), {
  label: "Selecciona:",
  multiple: true,
  value: [data[0]["Empresa"], data[1]["Empresa"]], // Selecciona las 2 primeras por defecto para que no salga vac칤o
  unique: true
})

filtered_data = data_long.filter(d => selected_companies.includes(d["Empresa"]))

Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "13px" },
  height: 450,
  marginRight: 130,
  x: { label: "A침o", tickFormat: "d" },
  y: { label: "Ventas (GWh)", grid: true },
  marks: [
    Plot.lineY(filtered_data, {
      x: "A침o", 
      y: "Ventas", 
      stroke: "Empresa", 
      strokeWidth: 3, 
      marker: "circle",
      curve: "monotone-x", 
      tip: true
    }),
    Plot.text(filtered_data, Plot.selectLast({
      x: "A침o", 
      y: "Ventas", 
      z: "Empresa", 
      text: "Empresa", 
      textAnchor: "start", 
      dx: 10,
      fill: "#cbd5e1",
      fontWeight: "bold"
    }))
  ],
  color: { scheme: "spectral", legend: true }
})
```