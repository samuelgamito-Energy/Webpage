---
title: "SECTOR ANALYTICS"
page-layout: full
format:
  html:
    toc: false
    css: styles.css
---

<style>
/* General */
.observablehq { color: #cbd5e1; font-family: 'Inter', sans-serif; }

/* Tabla Personalizada "Pro" */
.custom-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
  color: #cbd5e1;
}
.custom-table thead th {
  text-align: left;
  padding: 12px;
  border-bottom: 2px solid #2dd4bf;
  color: #2dd4bf;
  text-transform: uppercase;
  font-size: 0.8rem;
  letter-spacing: 1px;
}
.custom-table tbody tr {
  border-bottom: 1px solid #334155;
  transition: background 0.2s;
}
.custom-table tbody tr:hover {
  background-color: rgba(45, 212, 191, 0.1);
}
.custom-table td {
  padding: 10px 12px;
}

/* Bot√≥n de Acci√≥n (Ojo) */
.btn-action {
  background: transparent;
  border: 1px solid #334155;
  color: #2dd4bf;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 4px;
  transition: all 0.2s;
}
.btn-action:hover {
  background: #2dd4bf;
  color: #0f172a;
  box-shadow: 0 0 10px rgba(45, 212, 191, 0.4);
}

/* POPUP MODAL (La ventana flotante) */
dialog.company-modal {
  background: #0f172a;
  border: 2px solid #2dd4bf;
  border-radius: 12px;
  padding: 20px;
  color: #fff;
  max-width: 800px;
  width: 90%;
  box-shadow: 0 0 50px rgba(0,0,0,0.8);
}
dialog.company-modal::backdrop {
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(3px);
}
.close-btn {
  float: right;
  background: none;
  border: none;
  color: #94a3b8;
  font-size: 1.5rem;
  cursor: pointer;
}
.close-btn:hover { color: #fff; }

/* Inputs y Tabs */
form.observablehq-input input { 
  background-color: #1e293b !important; 
  border: 1px solid #334155 !important; 
  color: #fff !important; 
  padding: 8px; border-radius: 5px; 
}
.nav-tabs .nav-link.active { 
  background: transparent; 
  border-bottom: 3px solid #2dd4bf; 
  color: #2dd4bf !important; 
  font-weight: bold; 
}
.nav-tabs .nav-link { color: #94a3b8; }
</style>

```{ojs}
//| echo: false

// --- 1. CARGA DE DATOS ---
raw = await FileAttachment("ventas_boe.csv").text()

// --- 2. LIMPIEZA ---
clean_csv = raw.split(/\r?\n/).map(line => {
  let l = line.trim();
  if (!l) return null; 
  if (l.startsWith('"') && l.endsWith('"')) l = l.slice(1, -1);
  if (l.endsWith(';')) l = l.slice(0, -1);
  return l;
}).filter(l => l !== null).join("\n")

// --- 3. PARSEO DIN√ÅMICO ---
data = d3.dsvFormat(";").parse(clean_csv, (d, i, columns) => {
  const row = {
    "NIF": d[columns[0]],       // Columna 1 siempre es NIF
    "Empresa": d[columns[1]]    // Columna 2 siempre es Nombre
  };

  // Detectar a√±os autom√°ticamente
  columns.forEach(col => {
    if (col.includes("Ventas")) {
      let valStr = d[col] ? d[col].toString() : "0";
      let val = parseFloat(valStr.replace(/\./g, "").replace(",", ".")) || 0;
      let year = col.replace("Ventas", "").trim();
      row[year] = val; // Guardamos "2024" => 1000
    }
  });
  return row;
})

// --- 4. FILTRADO DE A√ëOS (BORRAR 2025) ---
// Detectamos a√±os y EXCLUIMOS expl√≠citamente el 2025
years_found = Object.keys(data[0])
  .filter(k => !isNaN(k) && k.length === 4 && k !== "2025") // <--- AQU√ç BORRAMOS EL 2025
  .sort();

// Datos formato largo
data_long = data.flatMap(d => {
  return years_found.map(year => ({
    "Empresa": d["Empresa"],
    "NIF": d["NIF"],
    "A√±o": parseInt(year),
    "Ventas": d[year] || 0
  }));
})

// --- 5. L√ìGICA DEL POPUP ---
// Variable mutable para guardar la empresa seleccionada
mutable company_view = null;
```

::: {.panel-tabset}

## üìä Mercado Global

Visi√≥n macro del volumen total gestionado en Espa√±a (GWh).

```{ojs}
//| echo: false
Plot.plot({
  style: { background: "transparent", color: "#94a3b8", fontSize: "14px" },
  height: 400,
  marginLeft: 60,
  y: { grid: true, label: "Total GWh", tickFormat: "s" },
  x: { label: null, tickFormat: "d" },
  marks: [
    Plot.barY(data_long, Plot.groupX({y: "sum"}, {
      x: "A√±o", 
      y: "Ventas", 
      fill: "#2dd4bf", 
      fillOpacity: 0.8,
      tip: true,
      title: d => `${d.A√±o}: ${d.Ventas.toLocaleString("es-ES")} GWh`
    })),
    Plot.ruleY([0], {stroke: "#475569"})
  ]
})
```

## üÜö Comparador y Buscador

Localiza cualquier comercializadora y pulsa el **ojo (üëÅÔ∏è)** para ver su ficha detallada.

```{ojs}
//| echo: false
// 1. Buscador
viewof searchTerm = Inputs.search(data, {
  placeholder: "Buscar por nombre o NIF...",
  columns: ["Empresa", "NIF"]
})

// 2. Tabla HTML Personalizada con Bot√≥n de Acci√≥n
// Usamos HTML puro para tener control total del dise√±o y los botones
htl.html`<div style="overflow-x: auto;">
  <table class="custom-table">
    <thead>
      <tr>
        <th>NIF</th>
        <th>COMERCIALIZADORA</th>
        <th style="text-align: right">VENTAS 2024 (GWh)</th>
        <th style="text-align: center">ACCI√ìN</th>
      </tr>
    </thead>
    <tbody>
      ${searchTerm.slice(0, 15).map(row => htl.html`
        <tr>
          <td style="font-family: monospace; color: #94a3b8;">${row.NIF}</td>
          <td style="font-weight: 600; color: #f1f5f9;">${row.Empresa}</td>
          <td style="text-align: right; color: #cbd5e1;">
            ${(row["2024"] || 0).toLocaleString("es-ES", {maximumFractionDigits: 2})}
          </td>
          <td style="text-align: center">
            <button class="btn-action" onclick=${() => { mutable company_view = row; }}>
              üëÅÔ∏è Ver Gr√°fica
            </button>
          </td>
        </tr>
      `)}
    </tbody>
  </table>
  <div style="margin-top: 10px; color: #64748b; font-size: 0.8rem; text-align: center;">
    Mostrando los primeros 15 resultados de la b√∫squeda.
  </div>
</div>`
```

:::

```{ojs}
//| echo: false
// Bloque reactivo: Dibuja el di√°logo cuando se selecciona una empresa
{
  if (company_view) {
    // Crear el elemento Dialog
    const dialog = htl.html`<dialog class="company-modal" open>
      <button class="close-btn" onclick=${() => dialog.close()}>&times;</button>
      
      <h2 style="color: #2dd4bf; margin-top: 0; border-bottom: 1px solid #334155; padding-bottom: 10px;">
        ${company_view.Empresa}
      </h2>
      
      <div style="display: flex; gap: 20px; margin-bottom: 20px; font-size: 0.9rem; color: #94a3b8;">
        <span><strong>NIF:</strong> ${company_view.NIF}</span>
        <span><strong>Total 2024:</strong> ${(company_view["2024"] || 0).toLocaleString("es-ES")} GWh</span>
      </div>

      <div id="chart-container"></div>
    </dialog>`;

    // Insertar el gr√°fico dentro del di√°logo
    const chart = Plot.plot({
      style: { background: "transparent", color: "#cbd5e1" },
      height: 300,
      x: { label: "A√±o", tickFormat: "d", domain: years_found.map(y => parseInt(y)) },
      y: { label: "Ventas (GWh)", grid: true },
      marks: [
        Plot.lineY(data_long.filter(d => d.Empresa === company_view.Empresa), {
          x: "A√±o", y: "Ventas", stroke: "#2dd4bf", strokeWidth: 3, marker: "circle", tip: true
        }),
        Plot.areaY(data_long.filter(d => d.Empresa === company_view.Empresa), {
          x: "A√±o", y: "Ventas", fill: "#2dd4bf", fillOpacity: 0.1
        })
      ]
    });

    dialog.querySelector("#chart-container").append(chart);

    // Evento para limpiar la variable cuando se cierra
    dialog.addEventListener("close", () => { mutable company_view = null; });
    
    // Mostrar en pantalla
    document.body.append(dialog);
    
    // Retornar para limpieza (OJS standard)
    return dialog;
  }
}
```